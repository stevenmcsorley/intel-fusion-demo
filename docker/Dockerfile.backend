FROM node:20-alpine

WORKDIR /app

# Copy all source code first
COPY . .

# Install shared dependencies first
WORKDIR /app/shared
RUN npm install

# Build shared package
RUN npm run build

# Install backend dependencies
WORKDIR /app/backend
RUN npm install

# Build backend
RUN npm run build

EXPOSE 3001

CMD ["npm", "run", "dev"]